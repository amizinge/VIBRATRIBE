generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  MODERATOR
  ADMIN
}

enum ReactionType {
  LIKE
  REPOST
}

model User {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  walletAddress String     @unique
  role          Role       @default(USER)
  profile       Profile?
  followers     Follow[]   @relation("followers")
  following     Follow[]   @relation("following")
  posts         Post[]
  comments      Comment[]
  messages      Message[]  @relation("MessageSender")
  notifications Notification[]
  reactions     Reaction[]
  sentTips      Tip[]      @relation("TipSender")
  receivedTips  Tip[]      @relation("TipReceiver")
  hostedSpaces  Space[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model Profile {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  handle       String   @unique
  displayName  String
  avatarUrl    String?
  bio          String?
  userId       String   @unique @db.ObjectId
  user         User     @relation(fields: [userId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Post {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  body      String
  mediaUrl  String?
  authorId  String      @db.ObjectId
  author    User        @relation(fields: [authorId], references: [id])
  tags      String[]
  comments  Comment[]
  tips      Tip[]
  reactions Reaction[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  body      String
  postId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id])
  authorId  String   @db.ObjectId
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}

model Reaction {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  type      ReactionType
  postId    String       @db.ObjectId
  post      Post         @relation(fields: [postId], references: [id])
  userId    String       @db.ObjectId
  user      User         @relation(fields: [userId], references: [id])
  createdAt DateTime     @default(now())
  @@unique([postId, userId, type])
}

model Follow {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  followerId  String   @db.ObjectId
  follower    User     @relation("followers", fields: [followerId], references: [id])
  followingId String   @db.ObjectId
  following   User     @relation("following", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())
  @@unique([followerId, followingId])
}

model Tip {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String?  @db.ObjectId
  post      Post?    @relation(fields: [postId], references: [id])
  senderId  String   @db.ObjectId
  sender    User     @relation("TipSender", fields: [senderId], references: [id])
  receiverId String   @db.ObjectId
  receiver   User     @relation("TipReceiver", fields: [receiverId], references: [id])
  token      String
  amount     String   // MongoDB doesn't support Decimal, using String for precision
  txHash     String
  createdAt  DateTime @default(now())
}

model Space {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  description  String
  hostId       String   @db.ObjectId
  host         User     @relation(fields: [hostId], references: [id])
  status       String
  startTime    DateTime
  gatingType   String
  tokenAddress String?
  minBalance   String?
  createdAt    DateTime @default(now())
}

model Conversation {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  participantIds String[] @db.ObjectId
  messages     Message[]
  createdAt    DateTime @default(now())
  
  @@map("conversations")
}

model Message {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  body           String
  conversationId String        @db.ObjectId
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  senderId       String        @db.ObjectId
  sender         User          @relation("MessageSender", fields: [senderId], references: [id])
  readAt         DateTime?
  createdAt      DateTime      @default(now())
}

model Report {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  postId     String   @db.ObjectId
  reporterId String   @db.ObjectId
  reason     String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  type      String
  payload   Json
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model AuthNonce {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  address   String
  nonce     String   @unique
  issuedAt  DateTime @default(now())
  expiresAt DateTime
}
